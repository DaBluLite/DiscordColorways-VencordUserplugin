/*
 * Vencord, a Discord client mod
 * Copyright (c) 2024 Vendicated and contributors
 * SPDX-License-Identifier: GPL-3.0-or-later
 */

import { IARRAY, IENDSTATEMENT, IEXPR, IFUNCALL, IFUNDEF, IMEMBER, INUMBER, IOP1, IOP2, IOP3, IVAR, IVARNAME } from "./instruction";

export default function expressionToString(tokens, toJS) {
    var nstack = [];
    var n1, n2, n3;
    var f, args, argCount;
    for (var i = 0; i < tokens.length; i++) {
        var item = tokens[i];
        var { type } = item;
        if (type === INUMBER) {
            if (typeof item.value === "number" && item.value < 0) {
                nstack.push("(" + item.value + ")");
            } else if (Array.isArray(item.value)) {
                nstack.push("[" + item.value.map(escapeValue).join(", ") + "]");
            } else {
                nstack.push(escapeValue(item.value));
            }
        } else if (type === IOP2) {
            n2 = nstack.pop();
            n1 = nstack.pop();
            f = item.value;
            if (toJS) {
                if (f === "^") {
                    nstack.push("Math.pow(" + n1 + ", " + n2 + ")");
                } else if (f === "and") {
                    nstack.push("(!!" + n1 + " && !!" + n2 + ")");
                } else if (f === "or") {
                    nstack.push("(!!" + n1 + " || !!" + n2 + ")");
                } else if (f === "||") {
                    nstack.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }((" + n1 + "),(" + n2 + ")))");
                } else if (f === "==") {
                    nstack.push("(" + n1 + " === " + n2 + ")");
                } else if (f === "!=") {
                    nstack.push("(" + n1 + " !== " + n2 + ")");
                } else if (f === "[") {
                    nstack.push(n1 + "[(" + n2 + ") | 0]");
                } else {
                    nstack.push("(" + n1 + " " + f + " " + n2 + ")");
                }
            } else {
                if (f === "[") {
                    nstack.push(n1 + "[" + n2 + "]");
                } else {
                    nstack.push("(" + n1 + " " + f + " " + n2 + ")");
                }
            }
        } else if (type === IOP3) {
            n3 = nstack.pop();
            n2 = nstack.pop();
            n1 = nstack.pop();
            f = item.value;
            if (f === "?") {
                nstack.push("(" + n1 + " ? " + n2 + " : " + n3 + ")");
            } else {
                throw new Error("invalid Expression");
            }
        } else if (type === IVAR || type === IVARNAME) {
            nstack.push(item.value);
        } else if (type === IOP1) {
            n1 = nstack.pop();
            f = item.value;
            if (f === "-" || f === "+") {
                nstack.push("(" + f + n1 + ")");
            } else if (toJS) {
                if (f === "not") {
                    nstack.push("(" + "!" + n1 + ")");
                } else if (f === "!") {
                    nstack.push("fac(" + n1 + ")");
                } else {
                    nstack.push(f + "(" + n1 + ")");
                }
            } else if (f === "!") {
                nstack.push("(" + n1 + "!)");
            } else {
                nstack.push("(" + f + " " + n1 + ")");
            }
        } else if (type === IFUNCALL) {
            argCount = item.value;
            args = [];
            while (argCount-- > 0) {
                args.unshift(nstack.pop());
            }
            f = nstack.pop();
            nstack.push(f + "(" + args.join(", ") + ")");
        } else if (type === IFUNDEF) {
            n2 = nstack.pop();
            argCount = item.value;
            args = [];
            while (argCount-- > 0) {
                args.unshift(nstack.pop());
            }
            n1 = nstack.pop();
            if (toJS) {
                nstack.push("(" + n1 + " = function(" + args.join(", ") + ") { return " + n2 + " })");
            } else {
                nstack.push("(" + n1 + "(" + args.join(", ") + ") = " + n2 + ")");
            }
        } else if (type === IMEMBER) {
            n1 = nstack.pop();
            nstack.push(n1 + "." + item.value);
        } else if (type === IARRAY) {
            argCount = item.value;
            args = [];
            while (argCount-- > 0) {
                args.unshift(nstack.pop());
            }
            nstack.push("[" + args.join(", ") + "]");
        } else if (type === IEXPR) {
            nstack.push("(" + expressionToString(item.value, toJS) + ")");
        } else if (type === IENDSTATEMENT) {
            // eslint-disable no-empty
        } else {
            throw new Error("invalid Expression");
        }
    }
    if (nstack.length > 1) {
        if (toJS) {
            nstack = [nstack.join(",")];
        } else {
            nstack = [nstack.join(";")];
        }
    }
    return String(nstack[0]);
}

function escapeValue(v) {
    if (typeof v === "string") {
        return JSON.stringify(v).replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
    }
    return v;
}
